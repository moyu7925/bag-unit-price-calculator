name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      debug_mode:
        description: '启用调试模式'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  ANDROID_API: 33
  ANDROID_NDK: 25b
  BUILD_TIMEOUT: 3600
  MAX_RETRIES: 3

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Cache Buildozer dependencies
      id: cache-buildozer
      uses: actions/cache@v4
      with:
        path: |
          ~/.buildozer
          buildozer.spec
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          python3-pip \
          build-essential \
          git \
          libffi-dev \
          libssl-dev \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libavformat-dev \
          libswscale-dev \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo-dev \
          cmake \
          openjdk-17-jdk \
          unzip \
          wget \
          curl

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --no-cache-dir cython==0.29.36 buildozer==1.5.0
        pip install --no-cache-dir requests

    - name: Accept Android SDK licenses
      run: |
        mkdir -p ~/.android
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.android/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.android/android-sdk-preview-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > ~/.android/google-android-ndk-license
        mkdir -p /home/runner/.buildozer/android/platform/android-sdk/licenses
        cp ~/.android/* /home/runner/.buildozer/android/platform/android-sdk/licenses/

    - name: Setup Android SDK
      run: |
        export ANDROID_HOME=/home/runner/.buildozer/android/platform/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        mkdir -p $ANDROID_HOME/cmdline-tools
        
        cd /tmp
        if [ ! -f "cmdline-tools.zip" ]; then
          wget -q --tries=3 --timeout=30 https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        fi
        
        unzip -q -o cmdline-tools.zip
        rm -rf $ANDROID_HOME/cmdline-tools/latest
        mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        
        chmod +x $ANDROID_HOME/cmdline-tools/latest/bin/*
        
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

    - name: Install Android SDK components
      run: |
        export ANDROID_HOME=/home/runner/.buildozer/android/platform/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        
        yes | sdkmanager --licenses || true
        
        sdkmanager --install "platform-tools" || true
        sdkmanager --install "platforms;android-${{ env.ANDROID_API }}" || true
        sdkmanager --install "build-tools;33.0.2" || true
        sdkmanager --install "build-tools;34.0.0" || true
        sdkmanager --install "ndk;${{ env.ANDROID_NDK }}" || true

    - name: Verify and fix Android SDK
      run: |
        export ANDROID_HOME=/home/runner/.buildozer/android/platform/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        
        echo "=== Verifying Android SDK installation ==="
        
        if [ ! -f "$ANDROID_HOME/platform-tools/aidl" ]; then
          echo "aidl not found, downloading platform-tools..."
          cd /tmp
          rm -rf platform-tools platform-tools.zip
          wget -q --tries=3 --timeout=30 https://dl.google.com/android/repository/platform-tools-latest-linux.zip -O platform-tools.zip
          unzip -q -o platform-tools.zip
          mkdir -p $ANDROID_HOME/platform-tools
          cp -rf platform-tools/* $ANDROID_HOME/platform-tools/
          chmod +x $ANDROID_HOME/platform-tools/aidl
        fi
        
        if [ -f "$ANDROID_HOME/platform-tools/aidl" ]; then
          echo "✓ aidl found"
          $ANDROID_HOME/platform-tools/aidl --version || true
        fi
        
        if [ -f "$ANDROID_HOME/build-tools/33.0.2/aidl" ]; then
          echo "✓ build-tools aidl found"
        fi
        
        find $ANDROID_HOME -name "aidl" -type f 2>/dev/null | head -5

    - name: Configure Buildozer
      run: |
        mkdir -p ~/.buildozer
        
        if [ ! -f buildozer.spec ]; then
          echo "buildozer.spec not found, creating default..."
          buildozer init
        fi
        
        sed -i 's/^android.api = .*/android.api = ${{ env.ANDROID_API }}/' buildozer.spec || true
        sed -i 's/^android.ndk = .*/android.ndk = ${{ env.ANDROID_NDK }}/' buildozer.spec || true
        sed -i 's/^android.minapi = .*/android.minapi = 21/' buildozer.spec || true
        sed -i 's/^android.sdk = .*/android.sdk = ${{ env.ANDROID_API }}/' buildozer.spec || true

    - name: Build APK with retry
      run: |
        export ANDROID_HOME=/home/runner/.buildozer/android/platform/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        echo "=== Starting Buildozer build ==="
        
        for attempt in $(seq 1 ${{ env.MAX_RETRIES }}); do
          echo "Attempt $attempt of ${{ env.MAX_RETRIES }}"
          
          if yes | buildozer android debug; then
            echo "✓ Build successful!"
            exit 0
          else
            echo "✗ Build failed on attempt $attempt"
            
            if [ $attempt -lt ${{ env.MAX_RETRIES }} ]; then
              echo "Cleaning and retrying..."
              buildozer android clean
              sleep 10
            else
              echo "Max retries reached"
              exit 1
            fi
          fi
        done

    - name: Verify APK
      if: success()
      run: |
        echo "=== Verifying APK ==="
        
        if [ -f bin/*.apk ]; then
          for apk in bin/*.apk; do
            echo "Found APK: $apk"
            ls -lh "$apk"
            
            if command -v aapt &> /dev/null; then
              aapt dump badging "$apk" | head -20
            fi
          done
        else
          echo "No APK found in bin/"
          find . -name "*.apk" -type f
          exit 1
        fi

    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ github.sha }}
        path: bin/*.apk
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          .buildozer/
          bin/
        retention-days: 7

    - name: Build summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Android API**: ${{ env.ANDROID_API }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Android NDK**: ${{ env.ANDROID_NDK }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f bin/*.apk ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### APK Files" >> $GITHUB_STEP_SUMMARY
          ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY
        fi

    - name: Notify build status
      if: always()
      run: |
        STATUS="${{ job.status }}"
        echo "Build status: $STATUS"
        
        if [ "$STATUS" = "success" ]; then
          echo "✅ Build completed successfully"
        else
          echo "❌ Build failed"
          echo "Check the logs for details"
        fi

  monitor:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
    - name: Check build status
      run: |
        BUILD_STATUS="${{ needs.build.result }}"
        
        echo "Build job status: $BUILD_STATUS"
        
        if [ "$BUILD_STATUS" = "success" ]; then
          echo "✅ All checks passed"
          exit 0
        else
          echo "⚠️ Build failed or was cancelled"
          exit 1
        fi
